@model Webovka.Models.Product
@using System.Text.Json
@{
    ViewData["Title"] = Model.Name;
    var related = ViewBag.RelatedProducts as List<Webovka.Models.Product>;

    // Data pro JS
    var uniqueColors = Model.Variants.GroupBy(v => v.Color).Select(g => g.First()).ToList();
    var uniqueSizes = Model.Variants.Select(v => v.Size).Distinct().OrderBy(s => s.Length).ThenBy(s => s).ToList();

    // Serializace bez async
    var variantsJson = JsonSerializer.Serialize(Model.Variants.Select(v => new
    {
        id = v.Id,
        color = v.Color,
        size = v.Size,
        stock = v.StockQuantity
    }));
}

<section class="product-detail-section">
    <div class="container detail-container">

        <div class="detail-gallery">
            <div class="main-image-wrapper">
                <img id="mainImg" src="@Model.MainImageUrl" alt="@Model.Name">
            </div>
            @if (Model.Images != null && Model.Images.Any())
            {
                <div class="gallery-thumbs">
                    <img src="@Model.MainImageUrl" class="thumb active" onclick="switchImg(this)">
                    @foreach (var img in Model.Images)
                    {
                        <img src="@img.ImageUrl" class="thumb" onclick="switchImg(this)">
                    }
                </div>
            }
        </div>

        <div class="detail-info">
            <div class="info-cat">@(Model.Category?.Name ?? "Obuv")</div>
            <h1 class="info-title">@Model.Name</h1>
            <div class="info-price">@Model.Price Kč</div>

            <div class="info-desc">
                @(Model.Description ?? "Popis produktu.")
            </div>

            <div class="selector-row">
                <span class="selector-label">BARVA: <span id="lblColor" class="selected-val"></span></span>
                <div class="colors-wrap">
                    @foreach (var c in uniqueColors)
                    {
                        <div class="color-circle"
                             style="background-color: @(c.ColorHex ?? "#eee")"
                             title="@c.Color"
                             onclick="selectColor('@c.Color', this)">
                        </div>
                    }
                </div>
            </div>

            <div class="selector-row">
                <span class="selector-label">VELIKOST: <span id="lblSize" class="selected-val"></span></span>
                <div class="sizes-wrap">
                    @foreach (var s in uniqueSizes)
                    {
                        <div class="size-box" data-size="@s" onclick="selectSize('@s', this)">
                            @s
                        </div>
                    }
                </div>
            </div>

            <form asp-controller="Cart" asp-action="AddToCart" method="post">
                <input type="hidden" name="productId" value="@Model.Id">
                <input type="hidden" name="variantId" id="inpVariantId">

                <div class="cart-actions">
                    <input type="number" name="quantity" value="1" min="1" class="qty-input">
                    <button type="submit" id="btnCart" class="btn-buy" disabled>Vyberte variantu</button>
                </div>
            </form>

            <div class="stock-status" id="stockMsg"></div>

            <div style="margin-top: 30px; font-size: 0.9rem; color: #777;">
                <div><img src="~/images/materialy/img/Group 195.png" width="16" style="vertical-align:middle"> Skladem</div>
                <div style="margin-top:5px"><img src="~/images/materialy/img/Group 196.png" width="16" style="vertical-align:middle"> Doprava zdarma</div>
            </div>
        </div>
    </div>
</section>

<section class="related-section">
    <div class="container">
        <div class="section-header">
            <h2>Mohlo by se vám <span>líbit</span></h2>
            <div class="separator"></div>
        </div>

        <div class="related-grid">
            @if (related != null)
            {
                foreach (var item in related)
                {
                    <div class="related-card">
                        <div class="related-img-wrap">
                            <a asp-action="Detail" asp-route-id="@item.Id">
                                <img src="@item.MainImageUrl" alt="@item.Name">
                            </a>
                        </div>
                        <a asp-action="Detail" asp-route-id="@item.Id" class="related-title">@item.Name</a>
                        <div class="related-price">@item.Price Kč</div>
                    </div>
                }
            }
        </div>
    </div>
</section>

<script>
    // JS pro galerii
    function switchImg(el) {
        document.getElementById('mainImg').src = el.src;
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }

    // JS pro varianty (shodný s minulým, jen upravené IDčka)
    const variants = @Html.Raw(variantsJson);
    let curColor = null;
    let curSize = null;

    function selectColor(color, el) {
        curColor = color;
        curSize = null;

        // UI Barvy
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('lblColor').innerText = color;

        // Reset Velikostí
        document.querySelectorAll('.size-box').forEach(s => {
            s.classList.remove('active');
            s.classList.remove('disabled');
        });
        document.getElementById('lblSize').innerText = "";

        // Zneaktivnit nedostupné velikosti
        document.querySelectorAll('.size-box').forEach(sb => {
            const sVal = sb.getAttribute('data-size');
            const v = variants.find(x => x.color === curColor && x.size === sVal);
            if(!v || v.stock <= 0) sb.classList.add('disabled');
        });

        updateBtn();
    }

    function selectSize(size, el) {
        if(!curColor) { alert('Vyberte nejdříve barvu.'); return; }

        curSize = size;
        document.querySelectorAll('.size-box').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('lblSize').innerText = size;

        updateBtn();
    }

    function updateBtn() {
        const btn = document.getElementById('btnCart');
        const inp = document.getElementById('inpVariantId');
        const msg = document.getElementById('stockMsg');

        if(curColor && curSize) {
            const v = variants.find(x => x.color === curColor && x.size === curSize);
            if(v && v.stock > 0) {
                inp.value = v.id;
                btn.disabled = false;
                btn.innerText = "VLOŽIT DO KOŠÍKU";
                msg.innerText = "Skladem: " + v.stock + " ks";
            }
        } else {
            btn.disabled = true;
            btn.innerText = "Vyberte variantu";
            msg.innerText = "";
        }
    }
</script>